#!/bin/sh
while ! pg_isready -U vela -d postgres; do sleep 1; done

if [ -f /vela/secrets/db/pgbouncer_admin_password ]; then
	pw=$(cat /vela/secrets/db/pgbouncer_admin_password)
	export PGBOUNCER_EXPORTER_CONNECTION_STRING="postgres://pgbouncer_admin:${pw}@localhost:6432/postgres?sslmode=disable"
fi

/usr/sbin/pgbouncer_exporter 2>&1 | tee /tmp/service-pgbouncer-exporter.fifo
